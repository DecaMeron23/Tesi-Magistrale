/*
 * srv_pwm_reader.c
 *
 *  Created on: 13 gen 2026
 *      Author: emilio
 */

#include "srv_pwm_reader.h"
#include "custom_stm.h"
#include "stdlib.h"
#include "app_conf.h"
#include "stm32_seq.h"

uint8_t ID_TIMER;

uint32_t getPWM();

void SRV_PWM_READER_ReadPWM_init()
{
	ID_TIMER = CUSTOM_APP_TIMER_ID_ReadPWM;

	HW_TS_ReturnStatus_t tim_ret = HW_TS_Create(CFG_TIM_PROC_ID_ISR, &(Custom_App_Context.TIMER_ID_ReadPWM),
			hw_ts_Repeated, SRV_PWM_READER_CallBack_ReadPWM_ISR);
	if (tim_ret != hw_ts_Successful)
	{
		Error_Handler();
	}
	UTIL_SEQ_RegTask(1 << CFG_TASK_NOTIFY_PWM_ID, UTIL_SEQ_RFU, SRV_PWM_READER_CallBack_ReadPWM);

}

void SRV_PWM_READER_StartNotifyPWM()
{
	HW_TS_Start(Custom_App_Context.TIMER_ID_ReadPWM, FIVE_SECONDS);
}
void SRV_PWM_READER_StopNotifyPWM()
{
	HW_TS_Stop(Custom_App_Context.TIMER_ID_ReadPWM);
}

void SRV_PWM_READER_CallBack_ReadPWM()
{
	SRV_PWM_READER_ReadPWM(NotifyCharData);
	Custom_STM_App_Update_Char(CUSTOM_STM_VARIABLE_CHAR, (uint8_t*) NotifyCharData);
}

void SRV_PWM_READER_CallBack_ReadPWM_ISR()
{
	UTIL_SEQ_SetTask(1 << CFG_TASK_NOTIFY_PWM_ID, CFG_SCH_PRIO_0);
}

void SRV_PWM_READER_ReadPWM(uint8_t *CharData)
{
	uint32_t freq = getPWM();
	CharData[0] = freq & 0xFF000000;
	CharData[1] = freq & 0x00FF0000;
	CharData[2] = freq & 0x0000FF00;
	CharData[3] = freq & 0x000000FF;
}

uint32_t getPWM()
{
	return rand() % 10000 + 1000;
}
