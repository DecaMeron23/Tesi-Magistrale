#include "pwm_signal.h"

void PWM_SIGNAL_Init(PWM_SIGNAL_TypeDef *sPWMSignal, uint32_t freq_clk, uint32_t pre_scaler, uint8_t is_16_bit)
{
	if (sPWMSignal) // Check se è null
	{
		return;
	}
	sPWMSignal->tim_freq = freq_clk / pre_scaler;
	sPWMSignal->is_16_bit = is_16_bit;
}

void PWM_SIGNAL_ComputePWM(PWM_SIGNAL_TypeDef *sPWMSignal, TIM_HandleTypeDef *htim, int channel, uint8_t is_rising)
{
	if (sPWMSignal) // Check se è null
	{
		return;
	}
	uint32_t current = HAL_TIM_ReadCapturedValue(htim, channel);
	uint32_t diff = current - sPWMSignal->prec;
	if (sPWMSignal->is_16_bit)
	{
		diff = (uint16_t) diff;
	}

	if (is_rising)
	{
		sPWMSignal->cycle_time = diff;
		sPWMSignal->prec = current;
	}
	else
	{
		sPWMSignal->up_time = diff;
	}
}

uint32_t PWM_SIGNAL_GetFrequency(PWM_SIGNAL_TypeDef *sPWMSignal)
{
	if (sPWMSignal == NULL)
	{
		return 0;
	}
	if (sPWMSignal->cycle_time == 0)
		return 0;
	return sPWMSignal->tim_freq / sPWMSignal->cycle_time;
}

uint8_t PWM_SIGNAL_GetDutyCycle(PWM_SIGNAL_TypeDef *sPWMSignal)
{
	if (sPWMSignal == NULL)
	{
		return 0;
	}
	if (sPWMSignal->cycle_time == 0)
		return 0;
	return ((float) sPWMSignal->up_time / sPWMSignal->cycle_time) * 100.0;
}

