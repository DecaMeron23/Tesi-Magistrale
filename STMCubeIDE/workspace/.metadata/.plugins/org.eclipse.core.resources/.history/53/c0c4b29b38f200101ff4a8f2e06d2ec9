/* USER CODE BEGIN Header */
/**
 ******************************************************************************
 * @file    App/custom_app.c
 * @author  MCD Application Team
 * @brief   Custom Example Application (Server)
 ******************************************************************************
 * @attention
 *
 * Copyright (c) 2026 STMicroelectronics.
 * All rights reserved.
 *
 * This software is licensed under terms that can be found in the LICENSE file
 * in the root directory of this software component.
 * If no LICENSE file comes with this software, it is provided AS-IS.
 *
 ******************************************************************************
 */
/* USER CODE END Header */

/* Includes ------------------------------------------------------------------*/
#include "main.h"
#include "app_common.h"
#include "dbg_trace.h"
#include "ble.h"
#include "custom_app.h"
#include "custom_stm.h"
#include "stm32_seq.h"

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
#include "TLC59731/TLC59731.h"
#include "PWM_SIGNAL/pwm_signal.h"
/* USER CODE END Includes */

/* Private typedef -----------------------------------------------------------*/
typedef struct
{
	/* GENERAL */
	/* PWM */
	uint8_t Frequency_Notification_Status;
	uint8_t Duty_cycle_Notification_Status;
	/* USER CODE BEGIN CUSTOM_APP_Context_t */
	PWM_SIGNAL_TypeDef sPWMSignal;
	uint8_t IDTimerFrequency;
	uint8_t IDTimerDutyCycle;
	/* USER CODE END CUSTOM_APP_Context_t */

	uint16_t ConnectionHandle;
} Custom_App_Context_t;

/* USER CODE BEGIN PTD */
typedef enum
{
	TIMER_FREQUENCY_ID, TIMER_DUTY_CYCLE_ID
} ID_TIMER_TypeDef;

typedef enum
{
	STATUS_OFF, STATUS_ON
} STATUS_TypeDef;

/* USER CODE END PTD */

/* Private defines ------------------------------------------------------------*/
/* USER CODE BEGIN PD */
extern RTC_HandleTypeDef hrtc;

#define CUSTOM_APP_FIVE_SECONDS (5 * 1e6 / CFG_TS_TICK_VAL)
#define CUSTOM_APP_TWO_SECONDS (2 * 1e6 / CFG_TS_TICK_VAL)
/* USER CODE END PD */

/* Private macros -------------------------------------------------------------*/
/* USER CODE BEGIN PM */
/* USER CODE END PM */

/* Private variables ---------------------------------------------------------*/
/**
 * START of Section BLE_APP_CONTEXT
 */

static Custom_App_Context_t Custom_App_Context;

/**
 * END of Section BLE_APP_CONTEXT
 */

uint8_t UpdateCharData[512];
uint8_t NotifyCharData[512];
uint16_t Connection_Handle;
/* USER CODE BEGIN PV */
char buff[200];
/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
/* GENERAL */
/* PWM */
static void Custom_Frequency_Update_Char(void);
static void Custom_Frequency_Send_Notification(void);
static void Custom_Duty_cycle_Update_Char(void);
static void Custom_Duty_cycle_Send_Notification(void);

/* USER CODE BEGIN PFP */
void Custom_Time_Update_Char(void);

void Custom_Time_Write_char(uint8_t *CharData);
void Custom_APP_FrequencyCallBack_ISR(void);
void Custom_APP_DutyCycleCallBack_ISR(void);
void Custom_APP_FrequencyCallBack(void);
void Custom_APP_DutyCycleCallBack(void);
/* USER CODE END PFP */

/* Functions Definition ------------------------------------------------------*/
void Custom_STM_App_Notification(Custom_STM_App_Notification_evt_t *pNotification)
{
	/* USER CODE BEGIN CUSTOM_STM_App_Notification_1 */
	/* USER CODE END CUSTOM_STM_App_Notification_1 */
	switch (pNotification->Custom_Evt_Opcode)
	{
		/* USER CODE BEGIN CUSTOM_STM_App_Notification_Custom_Evt_Opcode */

		/* USER CODE END CUSTOM_STM_App_Notification_Custom_Evt_Opcode */

		/* GENERAL */
		case CUSTOM_STM_TIME_READ_EVT:
			/* USER CODE BEGIN CUSTOM_STM_TIME_READ_EVT */
			Custom_Time_Update_Char();
			/* USER CODE END CUSTOM_STM_TIME_READ_EVT */
			break;

		case CUSTOM_STM_TIME_WRITE_NO_RESP_EVT:
			/* USER CODE BEGIN CUSTOM_STM_TIME_WRITE_NO_RESP_EVT */
			Custom_Time_Write_char(pNotification->DataTransfered.pPayload);
			/* USER CODE END CUSTOM_STM_TIME_WRITE_NO_RESP_EVT */
			break;

			/* PWM */
		case CUSTOM_STM_FREQUENCY_READ_EVT:
			/* USER CODE BEGIN CUSTOM_STM_FREQUENCY_READ_EVT */
			Custom_Frequency_Update_Char();
			/* USER CODE END CUSTOM_STM_FREQUENCY_READ_EVT */
			break;

		case CUSTOM_STM_FREQUENCY_NOTIFY_ENABLED_EVT:
			/* USER CODE BEGIN CUSTOM_STM_FREQUENCY_NOTIFY_ENABLED_EVT */
			HW_TS_Start(Custom_App_Context.IDTimerFrequency,
			CUSTOM_APP_TWO_SECONDS);
			sprintf(buff, "Evento 'START notify Frequency'\n");
			APP_DBG_MSG(buff)
			;
			/* USER CODE END CUSTOM_STM_FREQUENCY_NOTIFY_ENABLED_EVT */
			break;

		case CUSTOM_STM_FREQUENCY_NOTIFY_DISABLED_EVT:
			/* USER CODE BEGIN CUSTOM_STM_FREQUENCY_NOTIFY_DISABLED_EVT */
			HW_TS_Stop(Custom_App_Context.IDTimerFrequency);
			sprintf(buff, "Evento 'STOP notify Frequency'\n");
			APP_DBG_MSG(buff)
			;
			/* USER CODE END CUSTOM_STM_FREQUENCY_NOTIFY_DISABLED_EVT */
			break;

		case CUSTOM_STM_DUTY_CYCLE_READ_EVT:
			/* USER CODE BEGIN CUSTOM_STM_DUTY_CYCLE_READ_EVT */
			Custom_Duty_cycle_Update_Char();
			/* USER CODE END CUSTOM_STM_DUTY_CYCLE_READ_EVT */
			break;

		case CUSTOM_STM_DUTY_CYCLE_NOTIFY_ENABLED_EVT:
			/* USER CODE BEGIN CUSTOM_STM_DUTY_CYCLE_NOTIFY_ENABLED_EVT */
			HW_TS_Start(Custom_App_Context.IDTimerDutyCycle,
			CUSTOM_APP_TWO_SECONDS);
			sprintf(buff, "Evento 'START notify Duty Cycle'\n");
			APP_DBG_MSG(buff)
			;
			/* USER CODE END CUSTOM_STM_DUTY_CYCLE_NOTIFY_ENABLED_EVT */
			break;

		case CUSTOM_STM_DUTY_CYCLE_NOTIFY_DISABLED_EVT:
			/* USER CODE BEGIN CUSTOM_STM_DUTY_CYCLE_NOTIFY_DISABLED_EVT */
			HW_TS_Stop(Custom_App_Context.IDTimerDutyCycle);
			sprintf(buff, "Evento 'STOP notify Duty Cycle'\n");
			APP_DBG_MSG(buff)
			;
			/* USER CODE END CUSTOM_STM_DUTY_CYCLE_NOTIFY_DISABLED_EVT */
			break;

		case CUSTOM_STM_NOTIFICATION_COMPLETE_EVT:
			/* USER CODE BEGIN CUSTOM_STM_NOTIFICATION_COMPLETE_EVT */

			/* USER CODE END CUSTOM_STM_NOTIFICATION_COMPLETE_EVT */
			break;

		default:
			/* USER CODE BEGIN CUSTOM_STM_App_Notification_default */

			/* USER CODE END CUSTOM_STM_App_Notification_default */
			break;
	}
	/* USER CODE BEGIN CUSTOM_STM_App_Notification_2 */

	/* USER CODE END CUSTOM_STM_App_Notification_2 */
	return;
}

void Custom_APP_Notification(Custom_App_ConnHandle_Not_evt_t *pNotification)
{
	/* USER CODE BEGIN CUSTOM_APP_Notification_1 */

	/* USER CODE END CUSTOM_APP_Notification_1 */

	switch (pNotification->Custom_Evt_Opcode)
	{
		/* USER CODE BEGIN CUSTOM_APP_Notification_Custom_Evt_Opcode */

		/* USER CODE END P2PS_CUSTOM_Notification_Custom_Evt_Opcode */
		case CUSTOM_CONN_HANDLE_EVT:
			/* USER CODE BEGIN CUSTOM_CONN_HANDLE_EVT */
			TLC59731_On();
			HAL_Delay(200);
			TLC59731_Off();
			HAL_Delay(100);
			TLC59731_On();
			HAL_Delay(200);
			TLC59731_Off();
			/* USER CODE END CUSTOM_CONN_HANDLE_EVT */
			break;

		case CUSTOM_DISCON_HANDLE_EVT:
			/* USER CODE BEGIN CUSTOM_DISCON_HANDLE_EVT */
			TLC59731_On();
			HAL_Delay(500);
			TLC59731_Off();

			/* USER CODE END CUSTOM_DISCON_HANDLE_EVT */
			break;

		default:
			/* USER CODE BEGIN CUSTOM_APP_Notification_default */

			/* USER CODE END CUSTOM_APP_Notification_default */
			break;
	}

	/* USER CODE BEGIN CUSTOM_APP_Notification_2 */

	/* USER CODE END CUSTOM_APP_Notification_2 */

	return;
}

void Custom_APP_Init(void)
{
	/* USER CODE BEGIN CUSTOM_APP_Init */
	MX_APPE_Init();

	// INIZZIALIZZAZIONE DEL CONTESTO
	Custom_App_Context.IDTimerFrequency = TIMER_FREQUENCY_ID;
	Custom_App_Context.IDTimerDutyCycle = TIMER_DUTY_CYCLE_ID;
	Custom_App_Context.Frequency_Notification_Status = STATUS_OFF;
	Custom_App_Context.Duty_cycle_Notification_Status = STATUS_OFF;

	PWM_SIGNAL_Init(&Custom_App_Context.sPWMSignal, 32000000, 320, 0);

	// INIZZIALIZZAZIONE DEI SERVIZI -- SERVIZIO PMW
	HW_TS_Create(CFG_TIM_PROC_ID_ISR, TIMER_FREQUENCY_ID, hw_ts_Repeated, Custom_APP_FrequencyCallBack_ISR);
	HW_TS_Create(CFG_TIM_PROC_ID_ISR, TIMER_FREQUENCY_ID, hw_ts_Repeated, Custom_APP_DutyCycleCallBack_ISR);

	UTIL_SEQ_RegTask(1 << CFG_TASK_SRV_FREQ_NOTIFY_ID, UTIL_SEQ_RFU, Custom_Frequency_Send_Notification);
	UTIL_SEQ_RegTask(1 << CFG_TASK_SRV_DUTY_NOTIFY_ID, UTIL_SEQ_RFU, Custom_Duty_cycle_Send_Notification);

	/* USER CODE END CUSTOM_APP_Init */
	return;
}

/* USER CODE BEGIN FD */
void HAL_TIM_IC_CaptureCallback(TIM_HandleTypeDef *htim)
{
	if (htim->Instance == TIM2)
	{
		switch (htim->Channel)
		{
			case HAL_TIM_ACTIVE_CHANNEL_1:
				PWM_SIGNAL_ComputePWM(&Custom_App_Context.sPWMSignal, htim,
				TIM_CHANNEL_1, 1);
				break;
			case HAL_TIM_ACTIVE_CHANNEL_2:
				PWM_SIGNAL_ComputePWM(&Custom_App_Context.sPWMSignal, htim,
				TIM_CHANNEL_2, 0);
				break;
			default:
				break;
		}
	}
}
/* USER CODE END FD */

/*************************************************************
 *
 * LOCAL FUNCTIONS
 *
 *************************************************************/

/* GENERAL */
/* PWM */
__USED void Custom_Frequency_Update_Char(void) /* Property Read */
{
	uint8_t updateflag = 0;

	/* USER CODE BEGIN Frequency_UC_1*/
	updateflag = 1;
	uint32_t freq = PWM_SIGNAL_GetFrequency(&Custom_App_Context.sPWMSignal);
	memcpy(UpdateCharData, &freq, sizeof(uint32_t));
	/* USER CODE END Frequency_UC_1*/

	if (updateflag != 0)
	{
		Custom_STM_App_Update_Char(CUSTOM_STM_FREQUENCY, (uint8_t*) UpdateCharData);
	}

	/* USER CODE BEGIN Frequency_UC_Last*/
	sprintf(buff, "Evento 'READ Frequency' -- Frequenza: %u Hz \n",
			(UpdateCharData[3] << (3 * 8)) | (UpdateCharData[2] << (2 * 8)) | (UpdateCharData[1] << 8)
					| UpdateCharData[3]);
	APP_DBG_MSG(buff)
	;
	/* USER CODE END Frequency_UC_Last*/
	return;
}

void Custom_Frequency_Send_Notification(void) /* Property Notification */
{
	uint8_t updateflag = 0;

	/* USER CODE BEGIN Frequency_NS_1*/

	if (Custom_App_Context.Frequency_Notification_Status == STATUS_ON)
	{
		uint32_t freq = PWM_SIGNAL_GetFrequency(&Custom_App_Context.sPWMSignal);
		memcpy(NotifyCharData, &freq, sizeof(uint32_t));
	}

	/* USER CODE END Frequency_NS_1*/

	if (updateflag != 0)
	{
		Custom_STM_App_Update_Char(CUSTOM_STM_FREQUENCY, (uint8_t*) NotifyCharData);
	}

	/* USER CODE BEGIN Frequency_NS_Last*/
	sprintf(buff, "Evento 'READ NOTIFY Frequency' -- Frequenza: %u Hz \n",
			(UpdateCharData[0] << (3 * 8)) | (UpdateCharData[1] << (2 * 8)) | (UpdateCharData[2] << 8)
					| UpdateCharData[3]);
	APP_DBG_MSG(buff)
	;
	/* USER CODE END Frequency_NS_Last*/

	return;
}

__USED void Custom_Duty_cycle_Update_Char(void) /* Property Read */
{
	uint8_t updateflag = 0;

	/* USER CODE BEGIN Duty_cycle_UC_1*/
	updateflag = 1;
	UpdateCharData[0] = PWM_SIGNAL_GetDutyCycle(&Custom_App_Context.sPWMSignal);
	/* USER CODE END Duty_cycle_UC_1*/

	if (updateflag != 0)
	{
		Custom_STM_App_Update_Char(CUSTOM_STM_DUTY_CYCLE, (uint8_t*) UpdateCharData);
	}

	/* USER CODE BEGIN Duty_cycle_UC_Last*/
	sprintf(buff, "Evento 'READ Duty Cycle' -- Duty Cycle: %d % \n", UpdateCharData[0]);
	APP_DBG_MSG(buff)
	;
	/* USER CODE END Duty_cycle_UC_Last*/
	return;
}

void Custom_Duty_cycle_Send_Notification(void) /* Property Notification */
{
	uint8_t updateflag = 0;

	/* USER CODE BEGIN Duty_cycle_NS_1*/
	if (Custom_App_Context.Duty_cycle_Notification_Status == STATUS_ON)
	{
		updateflag = 1;
		UpdateCharData[0] = PWM_SIGNAL_GetDutyCycle(&Custom_App_Context.sPWMSignal);
	}
	/* USER CODE END Duty_cycle_NS_1*/

	if (updateflag != 0)
	{
		Custom_STM_App_Update_Char(CUSTOM_STM_DUTY_CYCLE, (uint8_t*) NotifyCharData);
	}

	/* USER CODE BEGIN Duty_cycle_NS_Last*/
	sprintf(buff, "Evento 'NOTIFY READ Duty Cycle' -- Duty Cycle: %d \n", NotifyCharData[0]);
	APP_DBG_MSG(buff)
	;
	/* USER CODE END Duty_cycle_NS_Last*/

	return;
}

/* USER CODE BEGIN FD_LOCAL_FUNCTIONS*/
__USED void Custom_Time_Update_Char(void)
{
	uint8_t updateflag = 0;

	updateflag = 1;

	RTC_DateTypeDef sDate =
	{ 0 };

	RTC_TimeTypeDef sTime =
	{ 0 };

	HAL_RTC_GetDate(&hrtc, &sDate, RTC_FORMAT_BCD);
	HAL_RTC_GetTime(&hrtc, &sTime, RTC_FORMAT_BCD);

	UpdateCharData[0] = sDate.Year;
	UpdateCharData[1] = sDate.Month;
	UpdateCharData[2] = sDate.Date;
	UpdateCharData[3] = sDate.WeekDay;

	UpdateCharData[4] = sTime.Hours;
	UpdateCharData[5] = sTime.Minutes;
	UpdateCharData[6] = sTime.Seconds;

	if (updateflag != 0)
	{
		Custom_STM_App_Update_Char(CUSTOM_STM_TIME, (uint8_t*) UpdateCharData);
	}

	sprintf(buff, "Evento 'Lettura Time' -- Dato letto: 20%02X/%02X/%02X %02X %02X:%02X:%02X \n", UpdateCharData[0],
			UpdateCharData[1], UpdateCharData[2], UpdateCharData[3], UpdateCharData[4], UpdateCharData[5],
			UpdateCharData[6]);
	APP_DBG_MSG(buff)
	return;
}

void Custom_Time_Write_char(uint8_t *CharData)
{
	RTC_DateTypeDef sDate =
	{ 0 };

	RTC_TimeTypeDef sTime =
	{ 0 };

	sDate.Year = CharData[0];
	sDate.Month = CharData[1];
	sDate.Date = CharData[2];
	sDate.WeekDay = CharData[3];

	sTime.Hours = CharData[4];
	sTime.Minutes = CharData[5];
	sTime.Seconds = CharData[6];

	HAL_RTC_SetDate(&hrtc, &sDate, RTC_FORMAT_BCD);
	HAL_RTC_SetTime(&hrtc, &sTime, RTC_FORMAT_BCD);

	sprintf(buff,
			"Evento 'CUSTOM_STM_TIME_CHAR_WRITE_NO_RESP_EVT' -- Calendario Inviato: 20%02X/%02X/%02X %02X %02X:%02X:%02X \n",
			CharData[0], CharData[1], CharData[2], CharData[3], CharData[4], CharData[5], CharData[6]);
	APP_DBG_MSG(buff)

}

void Custom_APP_FrequencyCallBack_ISR(void)
{
	UTIL_SEQ_SetTask(1 << CFG_TASK_SRV_FREQ_NOTIFY_ID, CFG_SCH_PRIO_0);
}
void Custom_APP_DutyCycleCallBack_ISR(void)
{
	UTIL_SEQ_SetTask(1 << CFG_TASK_SRV_DUTY_NOTIFY_ID, CFG_SCH_PRIO_0);
}

/* USER CODE END FD_LOCAL_FUNCTIONS*/
